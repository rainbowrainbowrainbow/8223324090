<!DOCTYPE html>
<html lang="uk">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0, maximum-scale=1.0, user-scalable=no">
    <title>–ö–ª–µ—à–Ω—è ‚Äî –ü–∞—Ä–∫ –ó–∞–∫—Ä–µ–≤—Å—å–∫–æ–≥–æ –ü–µ—Ä—ñ–æ–¥—É</title>
    <link rel="icon" type="image/png" href="images/favicon-32.png" sizes="32x32">
    <link rel="stylesheet" href="css/base.css?v=12.1">
    <link rel="stylesheet" href="css/layout.css?v=12.1">
    <link rel="stylesheet" href="css/pages.css?v=12.1">
    <link rel="stylesheet" href="css/modals.css?v=12.1">
    <link rel="stylesheet" href="css/dark-mode.css?v=12.1">
    <link rel="stylesheet" href="css/responsive.css?v=12.1">
    <link rel="preconnect" href="https://fonts.googleapis.com">
    <link href="https://fonts.googleapis.com/css2?family=Nunito:wght@400;600;700;800;900&display=swap" rel="stylesheet">
    <style>
        .kleshnya-page { max-width: 800px; margin: 0 auto; padding: 16px; display: flex; flex-direction: column; height: calc(100vh - 70px); }
        .kleshnya-header { text-align: center; padding: 16px 0 8px; }
        .kleshnya-header h2 { font-size: 20px; color: var(--gray-800); display: flex; align-items: center; justify-content: center; gap: 8px; }
        .kleshnya-header p { font-size: 13px; color: var(--gray-500); margin-top: 4px; }
        .kleshnya-status { display: inline-flex; align-items: center; gap: 6px; padding: 4px 12px; border-radius: 20px; font-size: 11px; font-weight: 700; background: rgba(16,185,129,0.1); color: #059669; margin-top: 8px; }
        .kleshnya-status-dot { width: 6px; height: 6px; border-radius: 50%; background: #10B981; animation: pulse-dot 2s infinite; }
        @keyframes pulse-dot { 0%, 100% { opacity: 1; } 50% { opacity: 0.4; } }

        .chat-messages { flex: 1; overflow-y: auto; padding: 12px 0; display: flex; flex-direction: column; gap: 12px; }
        .chat-msg { display: flex; gap: 10px; max-width: 85%; animation: msg-in 0.3s ease-out; }
        .chat-msg--assistant { align-self: flex-start; }
        .chat-msg--user { align-self: flex-end; flex-direction: row-reverse; }
        @keyframes msg-in { from { opacity: 0; transform: translateY(8px); } to { opacity: 1; transform: translateY(0); } }

        .chat-msg-avatar { width: 36px; height: 36px; border-radius: 50%; display: flex; align-items: center; justify-content: center; font-size: 18px; flex-shrink: 0; }
        .chat-msg--assistant .chat-msg-avatar { background: linear-gradient(135deg, #FFEDD5, #FED7AA); }
        .chat-msg--user .chat-msg-avatar { background: linear-gradient(135deg, #ECFDF5, #BBF7D0); }

        .chat-msg-bubble { padding: 10px 14px; border-radius: 16px; font-size: 14px; line-height: 1.5; white-space: pre-line; }
        .chat-msg--assistant .chat-msg-bubble { background: #F9FAFB; border: 1px solid #E5E7EB; border-bottom-left-radius: 4px; color: var(--gray-800); }
        .chat-msg--user .chat-msg-bubble { background: linear-gradient(135deg, #10B981, #059669); color: #fff; border-bottom-right-radius: 4px; }

        .chat-msg-time { font-size: 10px; color: var(--gray-400); margin-top: 4px; padding: 0 4px; }
        .chat-msg--user .chat-msg-time { text-align: right; }

        .chat-input-area { display: flex; gap: 8px; padding: 12px 0 8px; border-top: 1px solid var(--gray-200); }
        .chat-input { flex: 1; padding: 12px 16px; border: 1px solid var(--gray-300); border-radius: 24px; font-family: inherit; font-size: 14px; outline: none; transition: border-color 0.2s; min-height: 44px; resize: none; }
        .chat-input:focus { border-color: var(--primary); box-shadow: 0 0 0 3px rgba(16,185,129,0.1); }
        .chat-send-btn { width: 44px; height: 44px; border: none; border-radius: 50%; background: linear-gradient(135deg, #EA580C, #C2410C); color: #fff; font-size: 18px; cursor: pointer; display: flex; align-items: center; justify-content: center; transition: transform 0.2s, opacity 0.2s; flex-shrink: 0; }
        .chat-send-btn:hover { transform: scale(1.05); }
        .chat-send-btn:disabled { opacity: 0.5; cursor: not-allowed; transform: none; }

        .chat-typing { display: flex; align-items: center; gap: 8px; padding: 8px 14px; font-size: 12px; color: var(--gray-500); }
        .chat-typing-dots { display: flex; gap: 4px; }
        .chat-typing-dots span { width: 6px; height: 6px; border-radius: 50%; background: var(--gray-400); animation: typing-bounce 1.4s infinite; }
        .chat-typing-dots span:nth-child(2) { animation-delay: 0.2s; }
        .chat-typing-dots span:nth-child(3) { animation-delay: 0.4s; }
        @keyframes typing-bounce { 0%, 60%, 100% { transform: translateY(0); } 30% { transform: translateY(-6px); } }

        .chat-hint { text-align: center; padding: 8px; font-size: 11px; color: var(--gray-400); }

        /* Report button */
        .chat-report-btn {
            width: 44px; height: 44px; border: none; border-radius: 50%;
            background: linear-gradient(135deg, #7C3AED, #6D28D9); color: #fff;
            font-size: 18px; cursor: pointer; display: flex; align-items: center;
            justify-content: center; transition: transform 0.2s; flex-shrink: 0;
        }
        .chat-report-btn:hover { transform: scale(1.05); }

        /* Report modal */
        .report-overlay {
            display: none; position: fixed; inset: 0; background: rgba(0,0,0,0.5);
            z-index: 1000; align-items: center; justify-content: center;
            backdrop-filter: blur(4px);
        }
        .report-overlay.visible { display: flex; }
        .report-modal {
            background: var(--white, #fff); border-radius: 16px; padding: 24px;
            max-width: 420px; width: 90%; box-shadow: 0 20px 60px rgba(0,0,0,0.2);
            animation: msg-in 0.3s ease-out;
        }
        .report-modal h3 { font-size: 18px; font-weight: 800; margin-bottom: 16px; display: flex; align-items: center; gap: 8px; }
        .report-type-row { display: flex; gap: 8px; margin-bottom: 12px; }
        .report-type-btn {
            flex: 1; padding: 10px; border: 2px solid var(--gray-200); border-radius: 10px;
            background: var(--gray-50, #f9fafb); cursor: pointer; text-align: center;
            font-family: inherit; font-size: 13px; font-weight: 700; transition: all 0.15s;
        }
        .report-type-btn.active { border-color: #7C3AED; background: rgba(124,58,237,0.08); color: #7C3AED; }
        .report-type-btn:hover { border-color: #7C3AED; }
        .report-modal label { display: block; font-size: 11px; font-weight: 700; color: var(--gray-500); text-transform: uppercase; letter-spacing: 0.5px; margin-bottom: 4px; }
        .report-modal input, .report-modal textarea, .report-modal select {
            width: 100%; padding: 10px 14px; border: 1px solid var(--gray-200); border-radius: 10px;
            font-family: inherit; font-size: 14px; box-sizing: border-box; min-height: 44px;
        }
        .report-modal input:focus, .report-modal textarea:focus, .report-modal select:focus {
            outline: none; border-color: #7C3AED; box-shadow: 0 0 0 3px rgba(124,58,237,0.1);
        }
        .report-modal textarea { resize: vertical; min-height: 80px; }
        .report-modal .form-group { margin-bottom: 12px; }
        .report-actions { display: flex; gap: 8px; margin-top: 16px; }
        .report-submit {
            flex: 1; padding: 12px; border: none; border-radius: 10px;
            background: linear-gradient(135deg, #7C3AED, #6D28D9); color: #fff;
            font-family: inherit; font-size: 14px; font-weight: 700; cursor: pointer;
            min-height: 44px; transition: transform 0.15s;
        }
        .report-submit:hover { transform: translateY(-1px); }
        .report-submit:disabled { opacity: 0.5; cursor: not-allowed; transform: none; }
        .report-cancel {
            flex: 1; padding: 12px; border: 1px solid var(--gray-200); border-radius: 10px;
            background: var(--white, #fff); color: var(--gray-600);
            font-family: inherit; font-size: 14px; font-weight: 700; cursor: pointer;
            min-height: 44px;
        }

        /* Report modal dark mode */
        body.dark-mode .report-modal { background: #1e1e2e; border: 1px solid rgba(255,255,255,0.1); }
        body.dark-mode .report-modal h3 { color: var(--gray-200); }
        body.dark-mode .report-type-btn { background: rgba(255,255,255,0.05); border-color: rgba(255,255,255,0.12); color: var(--gray-300); }
        body.dark-mode .report-type-btn.active { border-color: #A78BFA; background: rgba(124,58,237,0.15); color: #A78BFA; }
        body.dark-mode .report-modal input, body.dark-mode .report-modal textarea, body.dark-mode .report-modal select {
            background: rgba(255,255,255,0.06); border-color: rgba(255,255,255,0.12); color: var(--gray-200);
        }
        body.dark-mode .report-modal label { color: var(--gray-400); }
        body.dark-mode .report-cancel { background: rgba(255,255,255,0.06); border-color: rgba(255,255,255,0.12); color: var(--gray-300); }

        /* Dark mode */
        body.dark-mode .kleshnya-header h2 { color: var(--gray-100); }
        body.dark-mode .kleshnya-status { background: rgba(16,185,129,0.15); color: #6EE7B7; }
        body.dark-mode .chat-msg--assistant .chat-msg-bubble { background: var(--gray-100); border-color: var(--gray-200); color: var(--gray-800); }
        body.dark-mode .chat-msg--assistant .chat-msg-avatar { background: linear-gradient(135deg, rgba(234,88,12,0.2), rgba(234,88,12,0.1)); }
        body.dark-mode .chat-msg--user .chat-msg-avatar { background: linear-gradient(135deg, rgba(16,185,129,0.2), rgba(16,185,129,0.1)); }
        body.dark-mode .chat-input { background: var(--gray-100); border-color: var(--gray-200); color: var(--gray-800); }
        body.dark-mode .chat-input-area { border-top-color: var(--gray-200); }
    </style>
</head>
<body>
    <script>
    // Early dark mode to prevent flash (full init in initDarkMode after config.js loads)
    (function(){var s=localStorage.getItem('pzp_dark_mode');var h=new Date().getHours();var isDark=s==='true'||(s!=='false'&&(h>=20||h<7));if(isDark){document.body.classList.add('dark-mode');document.documentElement.setAttribute('data-theme','dark')}})();
    </script>

    <div id="loginScreen" class="login-screen hidden"></div>

    <div id="mainApp" class="main-app hidden">
        <header class="header">
            <div class="header-content">
                <div class="logo">
                    <img src="images/favicon-512.png" alt="–õ–æ–≥–æ—Ç–∏–ø" class="logo-img-small">
                    <div class="logo-text"><h1>–ü–∞—Ä–∫ –ó–∞–∫—Ä–µ–≤—Å—å–∫–æ–≥–æ –ü–µ—Ä—ñ–æ–¥—É</h1></div>
                </div>
                <nav class="header-nav">
                    <a href="/" class="nav-link">üìÖ <span class="nav-text">–¢–∞–π–º–ª–∞–π–Ω</span></a>
                    <a href="/tasks" class="nav-link">üìù <span class="nav-text">–ó–∞–¥–∞—á—ñ</span></a>
                    <a href="/programs" class="nav-link">üìö <span class="nav-text">–ü—Ä–æ–≥—Ä–∞–º–∏</span></a>
                    <a href="/staff" class="nav-link">üë• <span class="nav-text">–ì—Ä–∞—Ñ—ñ–∫</span></a>
                    <a href="/designs" class="nav-link">üé® <span class="nav-text">–î–∏–∑–∞–π–Ω–∏</span></a>
                    <a href="/kleshnya" class="nav-link active nav-link-kleshnya">ü¶Ä <span class="nav-text">–ö–ª–µ—à–Ω—è</span></a>
                </nav>
                <div class="user-panel">
                    <span id="currentUser" class="user-name" role="button" tabindex="0"></span>
                    <button id="logoutBtn" class="btn-logout">–í–∏–π—Ç–∏</button>
                </div>
            </div>
        </header>

        <main class="main-content">
            <div class="kleshnya-page">
                <div class="kleshnya-header">
                    <h2>ü¶Ä –ö–ª–µ—à–Ω—è</h2>
                    <p>–¶–µ–Ω—Ç—Ä–∞–ª—å–Ω–∏–π —ñ–Ω—Ç–µ–ª–µ–∫—Ç –ü–∞—Ä–∫—É –ó–∞–∫—Ä–µ–≤—Å—å–∫–æ–≥–æ –ü–µ—Ä—ñ–æ–¥—É</p>
                    <div class="kleshnya-status">
                        <span class="kleshnya-status-dot"></span>
                        <span>–û–Ω–ª–∞–π–Ω ‚Ä¢ Template Mode</span>
                    </div>
                </div>

                <div class="chat-messages" id="chatMessages">
                    <!-- Messages will be loaded here -->
                </div>

                <div class="chat-hint">
                    –ü–∏—Ç–∞–π –ø—Ä–æ –±—Ä–æ–Ω—é–≤–∞–Ω–Ω—è, –∑–∞–¥–∞—á—ñ, —Å—Ç—Ä—ñ–∫–∏ ‚Äî –ö–ª–µ—à–Ω—è –¥–æ–ø–æ–º–æ–∂–µ! ü¶Ä
                </div>

                <div class="chat-input-area">
                    <button class="chat-report-btn" id="reportBtn" title="–ü–æ–≤—ñ–¥–æ–º–∏—Ç–∏ –ø—Ä–æ –±–∞–≥ –∞–±–æ –ø–æ–∫—Ä–∞—â–µ–Ω–Ω—è">üêõ</button>
                    <input type="text" class="chat-input" id="chatInput" placeholder="–ù–∞–ø–∏—Å–∞—Ç–∏ –ö–ª–µ—à–Ω—ñ..." maxlength="500" autocomplete="off">
                    <button class="chat-send-btn" id="chatSendBtn" title="–ù–∞–¥—ñ—Å–ª–∞—Ç–∏">‚û§</button>
                </div>
            </div>
        </main>
    </div>

    <!-- Report Bug/Improvement Modal -->
    <div class="report-overlay" id="reportOverlay">
        <div class="report-modal">
            <h3>üêõ –ü–æ–∫—Ä–∞—â–∏—Ç–∏ —Å–∏—Å—Ç–µ–º—É</h3>
            <div class="report-type-row">
                <button class="report-type-btn active" data-type="bug" id="typeBug">üêõ –ë–∞–≥</button>
                <button class="report-type-btn" data-type="improvement" id="typeImprove">üí° –ü–æ–∫—Ä–∞—â–µ–Ω–Ω—è</button>
            </div>
            <div class="form-group">
                <label>–©–æ —Å—Ç–∞–ª–æ—Å—è / —â–æ –ø–æ–∫—Ä–∞—â–∏—Ç–∏?</label>
                <input type="text" id="reportTitle" placeholder="–ö–æ—Ä–æ—Ç–∫–æ –æ–ø–∏—à—ñ—Ç—å..." maxlength="200">
            </div>
            <div class="form-group">
                <label>–î–µ—Ç–∞–ª—ñ (–Ω–µ–æ–±–æ–≤'—è–∑–∫–æ–≤–æ)</label>
                <textarea id="reportDesc" placeholder="–ö—Ä–æ–∫–∏ –¥–ª—è –≤—ñ–¥—Ç–≤–æ—Ä–µ–Ω–Ω—è, —Å–∫—Ä—ñ–Ω—à–æ—Ç–∏, —ñ–¥–µ—ó..." maxlength="1000" rows="3"></textarea>
            </div>
            <div class="form-group">
                <label>–ü—Ä—ñ–æ—Ä–∏—Ç–µ—Ç</label>
                <select id="reportPriority">
                    <option value="normal" selected>–ó–≤–∏—á–∞–π–Ω–∏–π</option>
                    <option value="high">–í–∏—Å–æ–∫–∏–π</option>
                    <option value="low">–ù–∏–∑—å–∫–∏–π</option>
                </select>
            </div>
            <div class="report-actions">
                <button class="report-submit" id="reportSubmitBtn">–ù–∞–¥—ñ—Å–ª–∞—Ç–∏ –°–µ—Ä–≥—ñ—é</button>
                <button class="report-cancel" id="reportCancelBtn">–°–∫–∞—Å—É–≤–∞—Ç–∏</button>
            </div>
        </div>
    </div>

    <script src="js/config.js?v=12.1"></script>
    <script src="js/api.js?v=12.1"></script>
    <script src="js/auth.js?v=12.1"></script>
    <script>
    // Kleshnya Chat Page Logic
    (function() {
        const API_BASE = '/api';
        const chatMessages = document.getElementById('chatMessages');
        const chatInput = document.getElementById('chatInput');
        const chatSendBtn = document.getElementById('chatSendBtn');

        function getToken() {
            return localStorage.getItem('pzp_token');
        }

        function formatTime(dateStr) {
            const d = new Date(dateStr);
            return d.toLocaleString('uk-UA', { timeZone: 'Europe/Kyiv', hour: '2-digit', minute: '2-digit' });
        }

        function addMessage(role, text, time) {
            const msg = document.createElement('div');
            msg.className = `chat-msg chat-msg--${role}`;

            const avatar = document.createElement('div');
            avatar.className = 'chat-msg-avatar';
            avatar.textContent = role === 'assistant' ? 'ü¶Ä' : 'üë§';

            const wrapper = document.createElement('div');

            const bubble = document.createElement('div');
            bubble.className = 'chat-msg-bubble';
            bubble.textContent = text;

            wrapper.appendChild(bubble);

            if (time) {
                const timeEl = document.createElement('div');
                timeEl.className = 'chat-msg-time';
                timeEl.textContent = formatTime(time);
                wrapper.appendChild(timeEl);
            }

            msg.appendChild(avatar);
            msg.appendChild(wrapper);
            chatMessages.appendChild(msg);
            chatMessages.scrollTop = chatMessages.scrollHeight;
        }

        function showTyping() {
            const typing = document.createElement('div');
            typing.className = 'chat-typing';
            typing.id = 'typingIndicator';
            typing.innerHTML = '<span>ü¶Ä –ö–ª–µ—à–Ω—è –¥—Ä—É–∫—É—î</span><div class="chat-typing-dots"><span></span><span></span><span></span></div>';
            chatMessages.appendChild(typing);
            chatMessages.scrollTop = chatMessages.scrollHeight;
        }

        function hideTyping() {
            const t = document.getElementById('typingIndicator');
            if (t) t.remove();
        }

        async function loadChat() {
            try {
                // Load greeting first
                const dateStr = new Date().toISOString().split('T')[0];
                const greeting = await apiGetKleshnyaGreeting(dateStr);

                // Load chat history
                const history = await apiGetKleshnyaChat();

                if (history.length === 0 && greeting) {
                    // First visit: show greeting as first message
                    addMessage('assistant', greeting.message, new Date().toISOString());
                } else if (history.length === 0) {
                    addMessage('assistant', 'ü¶Ä –ü—Ä–∏–≤—ñ—Ç! –Ø –ö–ª–µ—à–Ω—è ‚Äî —Ü–µ–Ω—Ç—Ä–∞–ª—å–Ω–∏–π —ñ–Ω—Ç–µ–ª–µ–∫—Ç –ø–∞—Ä–∫—É. –ü–∏—Ç–∞–π —â–æ –∑–∞–≤–≥–æ–¥–Ω–æ!', new Date().toISOString());
                } else {
                    // Show greeting + history
                    if (greeting) {
                        addMessage('assistant', greeting.message, new Date().toISOString());
                    }
                    for (const msg of history) {
                        addMessage(msg.role, msg.message, msg.created_at);
                    }
                }
            } catch (err) {
                console.error('Error loading chat:', err);
                addMessage('assistant', 'ü¶Ä –ü—Ä–∏–≤—ñ—Ç! –Ø –ö–ª–µ—à–Ω—è. –í–∏–Ω–∏–∫–ª–∞ –ø–æ–º–∏–ª–∫–∞ –ø—Ä–∏ –∑–∞–≤–∞–Ω—Ç–∞–∂–µ–Ω–Ω—ñ ‚Äî –∞–ª–µ —è –Ω–∞ –∑–≤\'—è–∑–∫—É!', new Date().toISOString());
            }
        }

        async function sendMessage() {
            const text = chatInput.value.trim();
            if (!text) return;

            chatInput.value = '';
            chatSendBtn.disabled = true;
            addMessage('user', text, new Date().toISOString());
            showTyping();

            try {
                const response = await apiSendKleshnyaMessage(text);
                hideTyping();

                if (response && response.message) {
                    addMessage('assistant', response.message, response.created_at || new Date().toISOString());
                } else {
                    addMessage('assistant', 'ü¶Ä –£–ø—Å, —â–æ—Å—å –ø—ñ—à–ª–æ –Ω–µ —Ç–∞–∫. –°–ø—Ä–æ–±—É–π —â–µ —Ä–∞–∑!', new Date().toISOString());
                }
            } catch (err) {
                hideTyping();
                addMessage('assistant', 'ü¶Ä –ü–æ–º–∏–ª–∫–∞ –∑\'—î–¥–Ω–∞–Ω–Ω—è. –ü–µ—Ä–µ–≤—ñ—Ä —ñ–Ω—Ç–µ—Ä–Ω–µ—Ç!', new Date().toISOString());
            }

            chatSendBtn.disabled = false;
            chatInput.focus();
        }

        // Event listeners
        chatSendBtn.addEventListener('click', sendMessage);
        chatInput.addEventListener('keydown', (e) => {
            if (e.key === 'Enter' && !e.shiftKey) {
                e.preventDefault();
                sendMessage();
            }
        });

        // Auth check + load
        function checkAuth() {
            const token = getToken();
            if (!token) {
                window.location.href = '/';
                return;
            }

            const user = localStorage.getItem('pzp_current_user');
            if (user) {
                try {
                    const parsed = JSON.parse(user);
                    document.getElementById('currentUser').textContent = parsed.name || parsed.username || '';
                } catch {}
            }

            document.getElementById('mainApp').classList.remove('hidden');
            loadChat();
        }

        document.getElementById('logoutBtn').addEventListener('click', () => {
            localStorage.removeItem('pzp_token');
            localStorage.removeItem('pzp_current_user');
            localStorage.removeItem('pzp_session');
            window.location.href = '/';
        });

        checkAuth();

        // ==========================================
        // REPORT BUG / IMPROVEMENT
        // ==========================================
        const reportOverlay = document.getElementById('reportOverlay');
        const reportTitle = document.getElementById('reportTitle');
        const reportDesc = document.getElementById('reportDesc');
        const reportPriority = document.getElementById('reportPriority');
        const reportSubmitBtn = document.getElementById('reportSubmitBtn');
        let reportType = 'bug';

        document.getElementById('reportBtn').addEventListener('click', () => {
            reportOverlay.classList.add('visible');
            reportTitle.value = '';
            reportDesc.value = '';
            reportPriority.value = 'normal';
            reportTitle.focus();
        });

        document.getElementById('reportCancelBtn').addEventListener('click', () => {
            reportOverlay.classList.remove('visible');
        });
        reportOverlay.addEventListener('click', (e) => {
            if (e.target === reportOverlay) reportOverlay.classList.remove('visible');
        });

        // Type toggle
        document.querySelectorAll('.report-type-btn').forEach(btn => {
            btn.addEventListener('click', () => {
                document.querySelectorAll('.report-type-btn').forEach(b => b.classList.remove('active'));
                btn.classList.add('active');
                reportType = btn.dataset.type;
            });
        });

        reportSubmitBtn.addEventListener('click', async () => {
            const title = reportTitle.value.trim();
            if (!title) { reportTitle.focus(); return; }

            reportSubmitBtn.disabled = true;
            reportSubmitBtn.textContent = '–ù–∞–¥—Å–∏–ª–∞—é...';

            const emoji = reportType === 'bug' ? 'üêõ' : 'üí°';
            const label = reportType === 'bug' ? '–ë–∞–≥' : '–ü–æ–∫—Ä–∞—â–µ–Ω–Ω—è';
            const user = localStorage.getItem('pzp_current_user');
            let userName = '–ö–æ—Ä–∏—Å—Ç—É–≤–∞—á';
            try { userName = JSON.parse(user).name || JSON.parse(user).username; } catch {}

            try {
                const token = getToken();
                const res = await fetch('/api/tasks', {
                    method: 'POST',
                    headers: { 'Content-Type': 'application/json', 'Authorization': `Bearer ${token}` },
                    body: JSON.stringify({
                        title: `${emoji} ${label}: ${title}`,
                        description: (reportDesc.value.trim() ? reportDesc.value.trim() + '\n\n' : '') + `–í—ñ–¥: ${userName}`,
                        priority: reportPriority.value,
                        category: 'improvement',
                        assigned_to: 'Sergey',
                        source_type: 'kleshnya',
                        task_type: 'human'
                    })
                });

                if (!res.ok) throw new Error('–ù–µ –≤–¥–∞–ª–æ—Å—è —Å—Ç–≤–æ—Ä–∏—Ç–∏ –∑–∞–¥–∞—á—É');
                const data = await res.json();
                reportOverlay.classList.remove('visible');
                addMessage('assistant',
                    `ü¶Ä ${emoji} ${label} –ø—Ä–∏–π–Ω—è—Ç–æ!\n\nüìã "${title}"\nüë§ –ü—Ä–∏–∑–Ω–∞—á–µ–Ω–æ: –°–µ—Ä–≥—ñ–π\n‚ö° –ü—Ä—ñ–æ—Ä–∏—Ç–µ—Ç: ${reportPriority.value === 'high' ? '–í–∏—Å–æ–∫–∏–π' : reportPriority.value === 'low' ? '–ù–∏–∑—å–∫–∏–π' : '–ó–≤–∏—á–∞–π–Ω–∏–π'}\n\n–°–µ—Ä–≥—ñ–π –æ—Ç—Ä–∏–º–∞—î —Å–ø–æ–≤—ñ—â–µ–Ω–Ω—è –≤ Telegram. –î—è–∫—É—é –∑–∞ —Ñ—ñ–¥–±–µ–∫! üí™`,
                    new Date().toISOString()
                );
            } catch (err) {
                console.error('Report error:', err);
                addMessage('assistant', 'ü¶Ä –£–ø—Å, –Ω–µ –≤–¥–∞–ª–æ—Å—è —Å—Ç–≤–æ—Ä–∏—Ç–∏ –∑–∞–¥–∞—á—É. –°–ø—Ä–æ–±—É–π —â–µ —Ä–∞–∑!', new Date().toISOString());
                reportOverlay.classList.remove('visible');
            }

            reportSubmitBtn.disabled = false;
            reportSubmitBtn.textContent = '–ù–∞–¥—ñ—Å–ª–∞—Ç–∏ –°–µ—Ä–≥—ñ—é';
        });
    })();
    </script>
</body>
</html>
