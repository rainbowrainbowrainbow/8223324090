# –ü–õ–ê–ù: Kleshnya —á–µ—Ä–µ–∑ OpenClaw Chat

## –ö–æ–Ω—Ç–µ–∫—Å—Ç

**–ó–∞—Ä–∞–∑:** Kleshnya = template-based –±–æ—Ç (keyword matching, ~15 —à–∞–±–ª–æ–Ω—ñ–≤). –í—ñ–¥–ø–æ–≤—ñ–¥—ñ –∂–æ—Ä—Å—Ç–∫—ñ: "–±—Ä–æ–Ω—é–≤–∞–Ω–Ω—è?" -> "5 –±—Ä–æ–Ω—é–≤–∞–Ω—å –Ω–∞ 12500 –≥—Ä–Ω". –ù–µ–º–∞—î —Ä–µ–∞–ª—å–Ω–æ–≥–æ AI, –Ω–µ–º–∞—î –∫–æ–Ω—Ç–µ–∫—Å—Ç—É —Ä–æ–∑–º–æ–≤–∏, –Ω–µ–º–∞—î —Ä–æ–∑—É–º—ñ–Ω–Ω—è —Å–∫–ª–∞–¥–Ω–∏—Ö –∑–∞–ø–∏—Ç—ñ–≤.

**–Ü–¥–µ—è:** –ó—Ä–æ–±–∏—Ç–∏ Kleshnya —Ä–æ–∑—É–º–Ω–æ—é AI-–∞—Å–∏—Å—Ç–µ–Ω—Ç–∫–æ—é, —è–∫–∞ –ø—Ä–∞—Ü—é—î —á–µ—Ä–µ–∑ —á–∞—Ç OpenClaw ‚Äî –≤–∏–∫–æ—Ä–∏—Å—Ç–æ–≤—É—î —Ä–µ–∞–ª—å–Ω—ñ –¥–∞–Ω—ñ –ø–∞—Ä–∫—É (–±—Ä–æ–Ω—é–≤–∞–Ω–Ω—è, –∑–∞–¥–∞—á—ñ, –ø–µ—Ä—Å–æ–Ω–∞–ª, —Ñ—ñ–Ω–∞–Ω—Å–∏) + –∑–æ–≤–Ω—ñ—à–Ω—ñ–π LLM (Claude API) –¥–ª—è –≥–µ–Ω–µ—Ä–∞—Ü—ñ—ó –≤—ñ–¥–ø–æ–≤—ñ–¥–µ–π.

---

## –ê—Ä—Ö—ñ—Ç–µ–∫—Ç—É—Ä–∞: 3 —Ä—ñ–≤–Ω—ñ

```
‚îå‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îê
‚îÇ     FRONTEND (kleshnya.html + widget)   ‚îÇ
‚îÇ  –Ü—Å–Ω—É—é—á–∏–π UI ‚Äî –±–µ–∑ –∑–º—ñ–Ω, –ø—Ä–æ—Å—Ç–æ —Ä–æ–∑—É–º–Ω—ñ ‚îÇ
‚îÇ  –≤—ñ–¥–ø–æ–≤—ñ–¥—ñ –∑–∞–º—ñ—Å—Ç—å —à–∞–±–ª–æ–Ω—ñ–≤             ‚îÇ
‚îî‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚î¨‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îò
               ‚îÇ POST /api/kleshnya/chat
               ‚ñº
‚îå‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îê
‚îÇ     MIDDLEWARE (routes/kleshnya.js)      ‚îÇ
‚îÇ  ‚Ä¢ Auth (JWT)                           ‚îÇ
‚îÇ  ‚Ä¢ –ó–±—ñ—Ä –∫–æ–Ω—Ç–µ–∫—Å—Ç—É –∑ –ë–î (bookings,       ‚îÇ
‚îÇ    tasks, staff, revenue, afisha)        ‚îÇ
‚îÇ  ‚Ä¢ –§–æ—Ä–º—É–≤–∞–Ω–Ω—è system prompt –∑ –¥–∞–Ω–∏–º–∏    ‚îÇ
‚îÇ  ‚Ä¢ –í–∏–∫–ª–∏–∫ Claude API                    ‚îÇ
‚îÇ  ‚Ä¢ –ó–±–µ—Ä–µ–∂–µ–Ω–Ω—è –≤ kleshnya_chat           ‚îÇ
‚îÇ  ‚Ä¢ Fallback –Ω–∞ —à–∞–±–ª–æ–Ω–∏ —è–∫—â–æ AI fail     ‚îÇ
‚îî‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚î¨‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îò
               ‚îÇ POST https://api.anthropic.com
               ‚ñº
‚îå‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îê
‚îÇ     CLAUDE API (Haiku ‚Äî –¥–µ—à–µ–≤–æ + —à–≤–∏–¥–∫–æ)‚îÇ
‚îÇ  System prompt –∑ –∫–æ–Ω—Ç–µ–∫—Å—Ç–æ–º –ø–∞—Ä–∫—É +     ‚îÇ
‚îÇ  –æ—Å—Ç–∞–Ω–Ω—ñ 10 –ø–æ–≤—ñ–¥–æ–º–ª–µ–Ω—å –¥—ñ–∞–ª–æ–≥—É         ‚îÇ
‚îî‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îò
```

---

## –§–∞–∑–∏ —Ä–µ–∞–ª—ñ–∑–∞—Ü—ñ—ó

### –§–ê–ó–ê 1: AI Backend (Claude API —ñ–Ω—Ç–µ–≥—Ä–∞—Ü—ñ—è)
**–ú–µ—Ç–∞:** –ó–∞–º—ñ–Ω–∏—Ç–∏ `generateChatResponse()` –∑ keyword-matching –Ω–∞ Claude API

#### 1.1 –ù–æ–≤–∏–π —Å–µ—Ä–≤—ñ—Å `services/kleshnya-ai.js`

```javascript
// –ì–æ–ª–æ–≤–Ω–∞ —Ñ—É–Ω–∫—Ü—ñ—è
async function generateAIResponse(username, userMessage, chatHistory) {
    // 1. –ó—ñ–±—Ä–∞—Ç–∏ –∫–æ–Ω—Ç–µ–∫—Å—Ç
    const context = await gatherFullContext(username, getTodayDate());

    // 2. –ü–æ–±—É–¥—É–≤–∞—Ç–∏ system prompt
    const systemPrompt = buildSystemPrompt(context, username);

    // 3. –ü–æ–±—É–¥—É–≤–∞—Ç–∏ messages (–æ—Å—Ç–∞–Ω–Ω—ñ 10 –∑ —ñ—Å—Ç–æ—Ä—ñ—ó + –Ω–æ–≤–µ)
    const messages = buildMessages(chatHistory, userMessage);

    // 4. –í–∏–∫–ª–∏–∫–∞—Ç–∏ Claude API
    const response = await callClaudeAPI(systemPrompt, messages);

    // 5. Fallback –Ω–∞ —à–∞–±–ª–æ–Ω–∏ —è–∫—â–æ Claude –Ω–µ–¥–æ—Å—Ç—É–ø–Ω–∏–π
    return response || generateTemplateResponse(userMessage, context);
}
```

#### 1.2 System Prompt (—Å–µ—Ä—Ü–µ AI)

```
–¢–∏ ‚Äî –ö–ª–µ—à–Ω—è ü¶Ä, AI-–∞—Å–∏—Å—Ç–µ–Ω—Ç–∫–∞ –¥–∏—Ç—è—á–æ–≥–æ —Ä–æ–∑–≤–∞–∂–∞–ª—å–Ω–æ–≥–æ –ø–∞—Ä–∫—É "–ó–∞–∫—Ä–µ–≤—Å—å–∫–æ–≥–æ –ü–µ—Ä—ñ–æ–¥—É".

–•–ê–†–ê–ö–¢–ï–†:
- –î—Ä—É–∂–Ω—è, –µ–Ω–µ—Ä–≥—ñ–π–Ω–∞, –∑ –≥—É–º–æ—Ä–æ–º
- –ì–æ–≤–æ—Ä–∏—à —É–∫—Ä–∞—ó–Ω—Å—å–∫–æ—é
- –í–∏–∫–æ—Ä–∏—Å—Ç–æ–≤—É—î—à –µ–º–æ–¥–∑—ñ –ø–æ–º—ñ—Ä–Ω–æ
- –ö–æ—Ä–æ—Ç–∫—ñ –≤—ñ–¥–ø–æ–≤—ñ–¥—ñ (2-4 —Ä–µ—á–µ–Ω–Ω—è), —è–∫—â–æ –Ω–µ –ø—Ä–æ—Å—è—Ç—å –¥–µ—Ç–∞–ª—å–Ω—ñ—à–µ
- –ó–Ω–∞—î—à –≤—Å–µ –ø—Ä–æ –ø–∞—Ä–∫: –±—Ä–æ–Ω—é–≤–∞–Ω–Ω—è, –ø—Ä–æ–≥—Ä–∞–º–∏, –ø–µ—Ä—Å–æ–Ω–∞–ª, —Ñ—ñ–Ω–∞–Ω—Å–∏

–ü–û–¢–û–ß–ù–ò–ô –ö–û–ù–¢–ï–ö–°–¢ (—Å—å–æ–≥–æ–¥–Ω—ñ {date}, {dayName}):
üìä –ë—Ä–æ–Ω—é–≤–∞–Ω–Ω—è: {bookingsCount} –Ω–∞ {totalRevenue}‚Ç¥
   - –ü—ñ–¥—Ç–≤–µ—Ä–¥–∂–µ–Ω–∏—Ö: {confirmedCount}
   - –ü–æ–ø–µ—Ä–µ–¥–Ω—ñ—Ö: {preliminaryCount}
   - –°–∫–∞—Å–æ–≤–∞–Ω–∏—Ö: {cancelledCount}
üìã –ó–∞–¥–∞—á—ñ {username}: {pendingTasks} –∞–∫—Ç–∏–≤–Ω–∏—Ö, {overdueTasks} –ø—Ä–æ—Å—Ç—Ä–æ—á–µ–Ω–∏—Ö
üë• –ê–Ω—ñ–º–∞—Ç–æ—Ä—ñ–≤ –Ω–∞ –∑–º—ñ–Ω—ñ: {animatorsCount}
üî• –°—Ç—Ä—ñ–∫ {username}: {streak} –¥–Ω—ñ–≤
üìÖ –ê—Ñ—ñ—à–∞: {afishaEvents} –ø–æ–¥—ñ–π —Å—å–æ–≥–æ–¥–Ω—ñ

–î–ï–¢–ê–õ–Ü –ë–†–û–ù–Æ–í–ê–ù–¨ –°–¨–û–ì–û–î–ù–Ü:
{bookingsList ‚Äî —á–∞—Å, –ø—Ä–æ–≥—Ä–∞–º–∞, –∫—ñ–º–Ω–∞—Ç–∞, —Å—Ç–∞—Ç—É—Å, —Å—É–º–∞}

–ü–†–ê–í–ò–õ–ê:
- –ù–µ –≤–∏–≥–∞–¥—É–π –¥–∞–Ω—ñ —è–∫–∏—Ö –Ω–µ–º–∞—î –≤ –∫–æ–Ω—Ç–µ–∫—Å—Ç—ñ
- –î–ª—è —Ñ—ñ–Ω–∞–Ω—Å–æ–≤–∏—Ö –ø–∏—Ç–∞–Ω—å ‚Äî —Ç—ñ–ª—å–∫–∏ —Ç–æ—á–Ω—ñ —Ü–∏—Ñ—Ä–∏ –∑ –∫–æ–Ω—Ç–µ–∫—Å—Ç—É
- –Ø–∫—â–æ –Ω–µ –∑–Ω–∞—î—à ‚Äî —á–µ—Å–Ω–æ —Å–∫–∞–∂–∏ —ñ –ø–æ—Ä–∞–¥—å –∫–æ–≥–æ –∑–∞–ø–∏—Ç–∞—Ç–∏
- –î–ª—è –¥—ñ–π (—Å—Ç–≤–æ—Ä–∏—Ç–∏ –±—Ä–æ–Ω—é–≤–∞–Ω–Ω—è, –∑–º—ñ–Ω–∏—Ç–∏ —Å—Ç–∞—Ç—É—Å) ‚Äî —Å–∫–∞–∂–∏ —â–æ
  —Ü–µ –ø–æ—Ç—Ä—ñ–±–Ω–æ –∑—Ä–æ–±–∏—Ç–∏ –≤ CRM, —Ç–∏ –ø–æ–∫–∏ —Ç—ñ–ª—å–∫–∏ —ñ–Ω—Ñ–æ—Ä–º—É—î—à
```

#### 1.3 –†–æ–∑—à–∏—Ä–µ–Ω–∏–π –∑–±—ñ—Ä –∫–æ–Ω—Ç–µ–∫—Å—Ç—É `gatherFullContext()`

–ü–æ—Ç–æ—á–Ω–∏–π `gatherContext()` –∑–±–∏—Ä–∞—î 7 –ø–æ–ª—ñ–≤. –†–æ–∑—à–∏—Ä—é—î–º–æ –¥–æ ~15:

| –ü–æ–ª–µ | SQL | –ù–∞—â–æ |
|------|-----|------|
| `bookingsCount` | COUNT bookings WHERE date=today | –ó–∞–≥–∞–ª—å–Ω–∞ –∫—ñ–ª—å–∫—ñ—Å—Ç—å |
| `totalRevenue` | SUM price | –í–∏—Ä—É—á–∫–∞ |
| `confirmedCount` | COUNT WHERE status='confirmed' | –ü—ñ–¥—Ç–≤–µ—Ä–¥–∂–µ–Ω—ñ |
| `preliminaryCount` | COUNT WHERE status='preliminary' | –ü–æ–ø–µ—Ä–µ–¥–Ω—ñ |
| `cancelledCount` | COUNT WHERE status='cancelled' | –°–∫–∞—Å–æ–≤–∞–Ω—ñ |
| `bookingsList` | SELECT time, program_name, room, status, price | –î–µ—Ç–∞–ª—å–Ω–∏–π —Å–ø–∏—Å–æ–∫ |
| `pendingTasks` | COUNT tasks WHERE assigned_to=user, status NOT done | –ê–∫—Ç–∏–≤–Ω—ñ –∑–∞–¥–∞—á—ñ |
| `overdueTasks` | COUNT WHERE deadline < NOW() | –ü—Ä–æ—Å—Ç—Ä–æ—á–µ–Ω—ñ |
| `streak` | user_streaks.current_streak | –°—Ç—Ä—ñ–∫ |
| `animatorsCount` | COUNT DISTINCT line_id FROM lines_by_date | –ê–Ω—ñ–º–∞—Ç–æ—Ä–∏ |
| `afishaEvents` | COUNT afisha WHERE date=today | –ê—Ñ—ñ—à–∞ |
| `afishaList` | SELECT time, title, type FROM afisha | –î–µ—Ç–∞–ª—ñ –∞—Ñ—ñ—à—ñ |
| `staffOnDuty` | COUNT staff_schedule WHERE status='working' | –ü–µ—Ä—Å–æ–Ω–∞–ª –Ω–∞ –∑–º—ñ–Ω—ñ |
| `weekRevenue` | SUM price –∑–∞ –æ—Å—Ç–∞–Ω–Ω—ñ 7 –¥–Ω—ñ–≤ | –¢–∏–∂–Ω–µ–≤–∞ –≤–∏—Ä—É—á–∫–∞ |
| `tomorrowBookings` | COUNT bookings WHERE date=tomorrow | –ó–∞–≤—Ç—Ä–∞—à–Ω—ñ –±—Ä–æ–Ω—é–≤–∞–Ω–Ω—è |

#### 1.4 Claude API –≤–∏–∫–ª–∏–∫

```javascript
async function callClaudeAPI(systemPrompt, messages) {
    const ANTHROPIC_API_KEY = process.env.ANTHROPIC_API_KEY;
    if (!ANTHROPIC_API_KEY) return null; // fallback –Ω–∞ —à–∞–±–ª–æ–Ω–∏

    const response = await fetch('https://api.anthropic.com/v1/messages', {
        method: 'POST',
        headers: {
            'x-api-key': ANTHROPIC_API_KEY,
            'anthropic-version': '2023-06-01',
            'content-type': 'application/json'
        },
        body: JSON.stringify({
            model: 'claude-haiku-4-5-20251001',  // –®–≤–∏–¥–∫–æ + –¥–µ—à–µ–≤–æ
            max_tokens: 500,
            system: systemPrompt,
            messages: messages
        })
    });

    const data = await response.json();
    return data.content[0].text;
}
```

**–ß–æ–º—É Haiku:**
- ~$0.001 –∑–∞ –∑–∞–ø–∏—Ç (–¥—É–∂–µ –¥–µ—à–µ–≤–æ)
- –í—ñ–¥–ø–æ–≤—ñ–¥—å –∑–∞ <1 —Å–µ–∫
- –î–æ—Å—Ç–∞—Ç–Ω—å–æ —Ä–æ–∑—É–º–Ω–∏–π –¥–ª—è –ø–∞—Ä–∫-–∫–æ–Ω—Ç–µ–∫—Å—Ç—É
- –î–ª—è 100 –∑–∞–ø–∏—Ç—ñ–≤/–¥–µ–Ω—å = ~$3/–º—ñ—Å

#### 1.5 Chat History (multi-turn)

```javascript
function buildMessages(chatHistory, newMessage) {
    // –û—Å—Ç–∞–Ω–Ω—ñ 10 –ø–æ–≤—ñ–¥–æ–º–ª–µ–Ω—å –¥–ª—è –∫–æ–Ω—Ç–µ–∫—Å—Ç—É —Ä–æ–∑–º–æ–≤–∏
    const recent = chatHistory.slice(-10);
    const messages = recent.map(msg => ({
        role: msg.role,
        content: msg.message
    }));
    messages.push({ role: 'user', content: newMessage });
    return messages;
}
```

#### 1.6 –ö–µ—à—É–≤–∞–Ω–Ω—è –∫–æ–Ω—Ç–µ–∫—Å—Ç—É

–ö–æ–Ω—Ç–µ–∫—Å—Ç –∑–º—ñ–Ω—é—î—Ç—å—Å—è —Ä—ñ–¥–∫–æ (–Ω–æ–≤–µ –±—Ä–æ–Ω—é–≤–∞–Ω–Ω—è = ~–∫—ñ–ª—å–∫–∞ –Ω–∞ –≥–æ–¥–∏–Ω—É). –ö–µ—à—É—î–º–æ –Ω–∞ 5 —Ö–≤–∏–ª–∏–Ω:

```javascript
const contextCache = new Map(); // key: `${username}:${date}`, TTL: 5 min

async function getCachedContext(username, date) {
    const key = `${username}:${date}`;
    const cached = contextCache.get(key);
    if (cached && Date.now() - cached.ts < 5 * 60 * 1000) {
        return cached.data;
    }
    const data = await gatherFullContext(username, date);
    contextCache.set(key, { data, ts: Date.now() });
    return data;
}
```

#### 1.7 Rate limiting –¥–ª—è AI

–©–æ–± –Ω–µ –≤–∏—Ç—Ä–∞—á–∞—Ç–∏ –±—é–¥–∂–µ—Ç Claude:
- Max 30 AI –∑–∞–ø–∏—Ç—ñ–≤ –Ω–∞ —é–∑–µ—Ä–∞ –Ω–∞ –≥–æ–¥–∏–Ω—É
- –ü—ñ—Å–ª—è –ª—ñ–º—ñ—Ç—É ‚Äî fallback –Ω–∞ —à–∞–±–ª–æ–Ω–∏ –∑ –ø–æ–≤—ñ–¥–æ–º–ª–µ–Ω–Ω—è–º
- –û–∫—Ä–µ–º–∏–π counter –≤ –ø–∞–º'—è—Ç—ñ (Map)

---

### –§–ê–ó–ê 2: –û–Ω–æ–≤–ª–µ–Ω–Ω—è routes/kleshnya.js

#### 2.1 POST /api/kleshnya/chat ‚Äî –Ω–æ–≤–∞ –ª–æ–≥—ñ–∫–∞

```javascript
router.post('/chat', async (req, res) => {
    const { message } = req.body;
    const { username, name } = req.user;

    // 1. –ó–±–µ—Ä–µ–≥—Ç–∏ user message
    const userMsg = await addChatMessage(username, 'user', message);

    // 2. –û—Ç—Ä–∏–º–∞—Ç–∏ —ñ—Å—Ç–æ—Ä—ñ—é (–æ—Å—Ç–∞–Ω–Ω—ñ 10)
    const history = await getChatHistory(username, 10);

    // 3. –ì–µ–Ω–µ—Ä—É–≤–∞—Ç–∏ AI –≤—ñ–¥–ø–æ–≤—ñ–¥—å (–∑ fallback –Ω–∞ —à–∞–±–ª–æ–Ω–∏)
    const { text, source } = await generateAIResponse(username, message, history);

    // 4. –ó–±–µ—Ä–µ–≥—Ç–∏ assistant –≤—ñ–¥–ø–æ–≤—ñ–¥—å
    const assistantMsg = await addChatMessage(username, 'assistant', text);

    // 5. –ü–æ–≤–µ—Ä–Ω—É—Ç–∏
    res.json({
        role: 'assistant',
        message: text,
        source,  // 'ai' | 'template' | 'fallback'
        id: assistantMsg.id,
        created_at: assistantMsg.created_at
    });
});
```

#### 2.2 Graceful degradation

```
ANTHROPIC_API_KEY –≤—Å—Ç–∞–Ω–æ–≤–ª–µ–Ω–∏–π? ‚Üí Claude AI (source: 'ai')
     ‚Üì –ø–æ–º–∏–ª–∫–∞/timeout
Template response (source: 'template')
     ‚Üì –ø–æ–º–∏–ª–∫–∞
Fallback message (source: 'fallback')
```

–ë–µ–∑ API –∫–ª—é—á–∞ ‚Äî –≤—Å–µ –ø—Ä–∞—Ü—é—î —è–∫ –∑–∞—Ä–∞–∑ (—à–∞–±–ª–æ–Ω–∏). –¢–æ–±—Ç–æ —Ü—è –∑–º—ñ–Ω–∞ **backward-compatible**.

---

### –§–ê–ó–ê 3: –ù–æ–≤—ñ env –∑–º—ñ–Ω–Ω—ñ

```env
# Railway ‚Üí Settings ‚Üí Variables
ANTHROPIC_API_KEY=sk-ant-...          # Claude API –∫–ª—é—á
KLESHNYA_AI_ENABLED=true              # –í–∏–º–∏–∫–∞—á AI (–º–æ–∂–Ω–∞ false –¥–ª—è –¥–µ–±–∞–≥—É)
KLESHNYA_AI_MODEL=claude-haiku-4-5-20251001  # –ú–æ–¥–µ–ª—å (–º–æ–∂–Ω–∞ –∑–º—ñ–Ω–∏—Ç–∏)
KLESHNYA_AI_MAX_TOKENS=500            # –õ—ñ–º—ñ—Ç –≤—ñ–¥–ø–æ–≤—ñ–¥—ñ
KLESHNYA_RATE_LIMIT=30                # –ó–∞–ø–∏—Ç—ñ–≤ –Ω–∞ —é–∑–µ—Ä–∞ –Ω–∞ –≥–æ–¥–∏–Ω—É
```

---

### –§–ê–ó–ê 4: –ü—Ä–æ–∫–∞—á–∞–Ω—ñ —Ñ—ñ—á—ñ

#### 4.1 –†–æ–∑—É–º–Ω—ñ –ø—ñ–¥–∫–∞–∑–∫–∏ (Smart Suggestions)

–ü—ñ—Å–ª—è –≤—ñ–¥–ø–æ–≤—ñ–¥—ñ –ö–ª–µ—à–Ω—è –ø—Ä–æ–ø–æ–Ω—É—î follow-up –∫–Ω–æ–ø–∫–∏:

```
User: "–©–æ —Å—å–æ–≥–æ–¥–Ω—ñ?"
Kleshnya: "üìä –°—å–æ–≥–æ–¥–Ω—ñ 5 –±—Ä–æ–Ω—é–≤–∞–Ω—å –Ω–∞ 12500‚Ç¥,
2 –ø–æ–ø–µ—Ä–µ–¥–Ω—ñ—Ö. 3 –∑–∞–¥–∞—á—ñ –∞–∫—Ç–∏–≤–Ω—ñ."

[–ü–æ–∫–∞–∂–∏ –±—Ä–æ–Ω—é–≤–∞–Ω–Ω—è] [–Ø–∫—ñ –∑–∞–¥–∞—á—ñ?] [–°–∫—ñ–ª—å–∫–∏ –∞–Ω—ñ–º–∞—Ç–æ—Ä—ñ–≤?]
```

–†–µ–∞–ª—ñ–∑–∞—Ü—ñ—è: Claude –ø–æ–≤–µ—Ä—Ç–∞—î JSON –∑ `suggestions[]`:

```javascript
// –í system prompt –¥–æ–¥–∞—Ç–∏:
// –ü—ñ—Å–ª—è –≤—ñ–¥–ø–æ–≤—ñ–¥—ñ –¥–æ–¥–∞–π JSON –±–ª–æ–∫ –∑ 2-3 –ø—ñ–¥–∫–∞–∑–∫–∞–º–∏:
// <suggestions>["–ü–æ–∫–∞–∂–∏ –¥–µ—Ç–∞–ª—å–Ω—ñ—à–µ", "–ê –∑–∞–≤—Ç—Ä–∞?", "–•—Ç–æ –ø—Ä–∞—Ü—é—î?"]</suggestions>
```

Frontend –ø–∞—Ä—Å–∏—Ç—å —ñ –ø–æ–∫–∞–∑—É—î –∫–Ω–æ–ø–∫–∏.

#### 4.2 –ü–∏—Ç–∞–Ω–Ω—è –ø–æ –∫–æ–Ω–∫—Ä–µ—Ç–Ω–æ–º—É –±—Ä–æ–Ω—é–≤–∞–Ω–Ω—é

```
User: "–©–æ –∑–∞ –±—Ä–æ–Ω—é–≤–∞–Ω–Ω—è –æ 14:00?"
Kleshnya: "–û 14:00 ‚Äî –∫–≤–µ—Å—Ç '–ì—Ä–∞ –≤ –ö–∞–ª—å–º–∞—Ä–∞' (–ö–í7)
–≤ –ö—ñ–º–Ω–∞—Ç—ñ 1. 8 –¥—ñ—Ç–µ–π, 3300‚Ç¥. –°—Ç–∞—Ç—É—Å: –ø—ñ–¥—Ç–≤–µ—Ä–¥–∂–µ–Ω–æ.
–ê–Ω—ñ–º–∞—Ç–æ—Ä–∏: –í–∞–ª–µ—Ä—ñ—è, –ö—Ä—ñ—Å."
```

–î–ª—è —Ü—å–æ–≥–æ `bookingsList` –≤ –∫–æ–Ω—Ç–µ–∫—Å—Ç—ñ –≤–∫–ª—é—á–∞—î –ø–æ–≤–Ω—ñ –¥–µ—Ç–∞–ª—ñ.

#### 4.3 –ü–æ—Ä—ñ–≤–Ω—è–Ω–Ω—è –∑ –º–∏–Ω—É–ª–∏–º —Ç–∏–∂–Ω–µ–º

```
User: "–Ø–∫ —Å–ø—Ä–∞–≤–∏ –ø–æ—Ä—ñ–≤–Ω—è–Ω–æ –∑ –º–∏–Ω—É–ª–∏–º —Ç–∏–∂–Ω–µ–º?"
Kleshnya: "üìà –¶—å–æ–≥–æ —Ç–∏–∂–Ω—è 32 –±—Ä–æ–Ω—é–≤–∞–Ω–Ω—è –Ω–∞ 85000‚Ç¥
(+15% –≤—ñ–¥ –º–∏–Ω—É–ª–æ–≥–æ). –ü—ñ–Ω—å—è—Ç–∏ ‚Äî —Ö—ñ—Ç —Ç–∏–∂–Ω—è!"
```

–î–æ–¥–∞—Ç–∫–æ–≤–∏–π –∫–æ–Ω—Ç–µ–∫—Å—Ç: `lastWeekRevenue`, `lastWeekBookings`.

#### 4.4 –ù–∞–≥–∞–¥—É–≤–∞–Ω–Ω—è —Ç–∞ –ø—Ä–æ–∞–∫—Ç–∏–≤–Ω—ñ—Å—Ç—å

–ö–æ–ª–∏ —é–∑–µ—Ä –≤—ñ–¥–∫—Ä–∏–≤–∞—î —á–∞—Ç, –ö–ª–µ—à–Ω—è –º–æ–∂–µ —Å–∫–∞–∑–∞—Ç–∏:
```
"‚ö†Ô∏è –£ —Ç–µ–±–µ 2 –ø—Ä–æ—Å—Ç—Ä–æ—á–µ–Ω—ñ –∑–∞–¥–∞—á—ñ! –•–æ—á–µ—à –ø–æ–¥–∏–≤–∏—Ç–∏—Å—è?"
"üìû 3 –ø–æ–ø–µ—Ä–µ–¥–Ω—ñ—Ö –±—Ä–æ–Ω—é–≤–∞–Ω–Ω—è ‚Äî –≤–∞—Ä—Ç–æ –ø—ñ–¥—Ç–≤–µ—Ä–¥–∏—Ç–∏ –¥–æ 16:00"
```

–õ–æ–≥—ñ–∫–∞ –≤ `getGreeting()` ‚Äî –≤–∂–µ —á–∞—Å—Ç–∫–æ–≤–æ —î, —Ä–æ–∑—à–∏—Ä—é—î–º–æ.

#### 4.5 –ú—É–ª—å—Ç–∏–º–æ–¥–∞–ª—å–Ω—ñ—Å—Ç—å (–µ—Ç–∞–ø 2)

–ü—ñ–∑–Ω—ñ—à–µ –º–æ–∂–Ω–∞ –¥–æ–¥–∞—Ç–∏:
- –ì–æ–ª–æ—Å–æ–≤—ñ –ø–æ–≤—ñ–¥–æ–º–ª–µ–Ω–Ω—è (Whisper API ‚Üí —Ç–µ–∫—Å—Ç ‚Üí Claude)
- –ì—Ä–∞—Ñ—ñ–∫–∏ –≤–∏—Ä—É—á–∫–∏ (Chart.js –≤ —á–∞—Ç—ñ)
- –§–æ—Ç–æ-–≤—ñ–¥–ø–æ–≤—ñ–¥—ñ (QR-–∫–æ–¥ –¥–ª—è —Å–µ—Ä—Ç–∏—Ñ—ñ–∫–∞—Ç—É)

---

### –§–ê–ó–ê 5: OpenClaw —è–∫ –∑–æ–≤–Ω—ñ—à–Ω—ñ–π AI-–∫–ª—ñ—î–Ω—Ç

OpenClaw –±–æ—Ç –≤–∂–µ –ø—ñ–¥–∫–ª—é—á–µ–Ω–∏–π —á–µ—Ä–µ–∑ API. –ó–∞—Ä–∞–∑ –≤—ñ–Ω read-only ‚Äî —Ç—ñ–ª—å–∫–∏ GET.
–ú–æ–∂–Ω–∞ –∑—Ä–æ–±–∏—Ç–∏ —Ç–∞–∫ —â–æ OpenClaw —Ç–µ–∂ –≤–∏–∫–æ—Ä–∏—Å—Ç–æ–≤—É—î Kleshnya chat:

```
OpenClaw ‚Üí POST /api/kleshnya/chat { message: "..." }
         ‚Üí –û—Ç—Ä–∏–º—É—î AI-–≤—ñ–¥–ø–æ–≤—ñ–¥—å –≤—ñ–¥ –ö–ª–µ—à–Ω—ñ
         ‚Üí –ü–æ–∫–∞–∑—É—î —É —Å–≤–æ—î–º—É —ñ–Ω—Ç–µ—Ä—Ñ–µ–π—Å—ñ
```

–¶–µ –≤–∂–µ –ø—Ä–∞—Ü—é—î! OpenClaw –º–∞—î JWT —Ç–æ–∫–µ–Ω —ñ –º–æ–∂–µ —Ä–æ–±–∏—Ç–∏ POST.
–Ñ–¥–∏–Ω–µ —â–æ –ø–æ—Ç—Ä—ñ–±–Ω–æ ‚Äî –¥–æ–∑–≤–æ–ª–∏—Ç–∏ role='user' –¥–æ—Å—Ç—É–ø –¥–æ `/api/kleshnya/chat`.

---

## –§–∞–π–ª–∏ —è–∫—ñ –º—ñ–Ω—è—î–º–æ

| –§–∞–π–ª | –ó–º—ñ–Ω–∏ |
|------|-------|
| `services/kleshnya-ai.js` | **–ù–û–í–ò–ô** ‚Äî Claude API –≤–∏–∫–ª–∏–∫, context builder, system prompt |
| `services/kleshnya-greeting.js` | –†–æ–∑—à–∏—Ä–∏—Ç–∏ `gatherContext()` ‚Üí `gatherFullContext()` |
| `routes/kleshnya.js` | –ó–∞–º—ñ–Ω–∏—Ç–∏ `generateChatResponse()` –Ω–∞ AI + fallback |
| `utils/validateEnv.js` | –î–æ–¥–∞—Ç–∏ ANTHROPIC_API_KEY, KLESHNYA_* –∑–º—ñ–Ω–Ω—ñ |
| `kleshnya.html` | Smart suggestions UI (–∫–Ω–æ–ø–∫–∏ –ø—ñ—Å–ª—è –≤—ñ–¥–ø–æ–≤—ñ–¥—ñ) |
| `server.js` | –ù—ñ—á–æ–≥–æ –Ω–µ –º—ñ–Ω—è—î–º–æ (—Ä–æ—É—Ç–∏ –≤–∂–µ –ø—ñ–¥–∫–ª—é—á–µ–Ω—ñ) |

## –©–æ –ù–ï –º—ñ–Ω—è—î–º–æ

- –ë–î —Å—Ç—Ä—É–∫—Ç—É—Ä—É (kleshnya_chat, kleshnya_messages ‚Äî –¥–æ—Å—Ç–∞—Ç–Ω—å–æ)
- Frontend chat UI (–∑–∞–ª–∏—à–∞—î—Ç—å—Å—è —è–∫ —î)
- Widget –Ω–∞ timeline (–∑–∞–ª–∏—à–∞—î—Ç—å—Å—è —è–∫ —î)
- Auth middleware (JWT –≤–∂–µ –ø—Ä–∞—Ü—é—î)
- WebSocket (–Ω–µ –ø–æ—Ç—Ä—ñ–±–µ–Ω –¥–ª—è —á–∞—Ç—É ‚Äî HTTP –¥–æ—Å—Ç–∞—Ç–Ω—å–æ)

---

## –û—Ü—ñ–Ω–∫–∞ –≤–∞—Ä—Ç–æ—Å—Ç—ñ Claude API

| –ü–∞—Ä–∞–º–µ—Ç—Ä | –ó–Ω–∞—á–µ–Ω–Ω—è |
|----------|---------|
| –ú–æ–¥–µ–ª—å | claude-haiku-4-5-20251001 |
| Input tokens (~) | ~800 (system prompt + context + history) |
| Output tokens (~) | ~200 (–≤—ñ–¥–ø–æ–≤—ñ–¥—å) |
| –¶—ñ–Ω–∞ input | $1/MTok |
| –¶—ñ–Ω–∞ output | $5/MTok |
| –¶—ñ–Ω–∞ –∑–∞ –∑–∞–ø–∏—Ç | ~$0.002 |
| –ó–∞–ø–∏—Ç—ñ–≤ –Ω–∞ –¥–µ–Ω—å (~) | ~50-100 |
| **–ú—ñ—Å—è—á–Ω–∞ –≤–∞—Ä—Ç—ñ—Å—Ç—å** | **~$3-6** |

---

## –ü–æ—Ä—è–¥–æ–∫ —Ä–µ–∞–ª—ñ–∑–∞—Ü—ñ—ó

1. **`services/kleshnya-ai.js`** ‚Äî –Ω–æ–≤–∏–π —Å–µ—Ä–≤—ñ—Å (Claude API + context + prompt)
2. **`services/kleshnya-greeting.js`** ‚Äî —Ä–æ–∑—à–∏—Ä–∏—Ç–∏ gatherContext
3. **`routes/kleshnya.js`** ‚Äî –ø—ñ–¥–∫–ª—é—á–∏—Ç–∏ AI –∑ fallback
4. **`utils/validateEnv.js`** ‚Äî –Ω–æ–≤—ñ env –∑–º—ñ–Ω–Ω—ñ
5. **`kleshnya.html`** ‚Äî smart suggestions (—è–∫—â–æ —Ö–æ—á–µ–º–æ)
6. –¢–µ—Å—Ç–∏ –ª–æ–∫–∞–ª—å–Ω–æ
7. –î–æ–¥–∞—Ç–∏ `ANTHROPIC_API_KEY` –≤ Railway Variables
8. Push + deploy
